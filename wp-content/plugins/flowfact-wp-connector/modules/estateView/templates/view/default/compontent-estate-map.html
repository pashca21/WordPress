{% if ff_maps_no_highlight != 1 %}
	{% if ff_maps_default_provider == 1 %}
		{% if api.maps.key %}
			<div class="FFestateview-default-map">
				<div class="ffmap-consent">
					<div id="ffmap-details"></div>
					<div class="ff-consent-box">
						<div class="ff-consent">
							<b><small>Ergebnisse auf Karte anzeigen </small></b><br>
							<small>Diese Webseite nutzt Google Maps. Ich bin damit einverstanden,
							dass Google Maps für die Darstellung von Karten und für die
							eigene Zwecke die IP-Adresse meines Gerätes sowie weitere
							technische Daten erhält. Mit Aktivierung werden diese Daten an
							Google übermittelt. {% if privacy_page_url %} Weitere Details im <a href="{{ privacy_page_url }}" target="_blank">Datenschutzhinweis</a>.{% endif %} </small><br> 
							
						</div>
						<div class="ff-gmaps-consent">
							<div><small><b>Google Maps nutzen</b></small></div>
							
							<label class="ff-button-switch">
								<input type="checkbox" id="map-switch">
								<span class="ff-button-slider round"></span>
							</label>
						</div>
					</div>
				</div>
			</div>

			<script>
				var ffconsent = false;
				jQuery( "#map-switch" ).on("change", function() {
					
					if (this.checked) {
						jQuery('.ff-consent').hide()
						jQuery('.ff-consent-box').css('background-color', 'transparent')
						jQuery( "#ffmap-details" ).css('display', 'block');

						if(ffconsent == false) {
							// map style setting
							var style = [
								{ "elementType": "geometry", "stylers": [{ "saturation": -75 }]}
							];

							// map setting
							var map = new google.maps.Map(document.getElementById('ffmap-details'), {
								zoom: 12,
								maxZoom: 16,
								disableDefaultUI: false,
								center: {lat: {{ estates.geo.latitude.value-0.0000322 }}, lng: {{estates.geo.longitude.value-0.0000322}}},
								mapTypeId: google.maps.MapTypeId.ROADMAP
							});

							// map type
							var mapType = new google.maps.StyledMapType(style, {name:"Grayscale"});
							map.mapTypes.set('grey', mapType);
							map.setMapTypeId('grey');


							

							{% if estates.facts.addresses.value.street %} 

								// create svg for marker
								var icon = {
									url: getGoogleClusterMarkerSvg('{{color.primary}}'),
									fillOpacity: .9,
									anchor: new google.maps.Point(0,0),
									strokeWeight: 2,
									strokeColor: '{{color.primary}}',
									scale: 1
								}

								// create markers
								var markers = locations.map(function(location, i) {
									return new google.maps.Marker({
										position: location,
										map: map,
										animation: google.maps.Animation.DROP,
										draggable: false,
										icon: icon
									});
								});

							{% else %}
								// Scout Geo Service
								// get zipcode shapes ID based on at & lon

								var shapeURL = "https://box-shp.alias.s24cloud.net/shape?latitude={{ estates.geo.latitude.value }}&longitude={{ estates.geo.longitude.value }}&types=region,city,district,borough,town"

								console.log(shapeURL)

								jQuery.ajax({
									url: shapeURL,
									method: "GET",
									dataType: "json",
									success: function(data) {
										console.log(shapeURL)
										console.log('here')
										console.log(data);
										console.log('shape no: ')
										console.log(data.length - 1)
										var shapeID = data[data.length - 1].id
										
										getShapeCoords(shapeID)
									},
									error: function(jqXHR, textStatus, errorThrown) {
										console.log(shapeURL)
										console.log("Error dadssad: " + textStatus, errorThrown);
									}
								});

								function getShapeCoords(shapeID) {
									console.log("shape id ", shapeID);
									console.log('check this :')
									console.log('https://box-shp.alias.s24cloud.net/shape/'+shapeID);

									jQuery.ajax({
									url: 'https://box-shp.alias.s24cloud.net/shape/'+shapeID,
									method: "GET",
									dataType: "json",
									success: function(data) {
										console.log('here two')
										console.log(data)
										// in this case for Barcelona we have to use 3rd coords set coming from api
										// but we had it set for 1st set 
										if(data.geometry.coordinates.length > 1) {
											shapeCoords = data.geometry.coordinates[data.geometry.coordinates.length -1];
										} else {
											shapeCoords = data.geometry.coordinates;
										}

										
										console.log("get coords func",data);
										console.log(shapeCoords)
										highlightGmapsDistrict(shapeCoords)
									},
									error: function(jqXHR, textStatus, errorThrown) {
										console.log(shapeID)
										console.log("Error: " + textStatus, errorThrown);
									}
								});
								}

								function addLatLon(arr) {
									return arr.map(function(elem) {
										return {"lng": elem[0], "lat": elem[1]};
									});
								}

								function highlightGmapsDistrict(shapeCoords) {

									console.log('hgihglight')
									console.log(shapeCoords[0])

									highlightShapeCoords = addLatLon(shapeCoords[0])
								
									console.log('highlight shape coords after lat lon function')
									console.log(highlightShapeCoords)

									var districtBoundary = new google.maps.Polygon({
										paths: highlightShapeCoords,
										strokeColor: '#ff7800',
										strokeOpacity: 0.8,
										strokeWeight: 2,
										fillColor: '#ff7800',
										fillOpacity: 0.35
									});

									districtBoundary.setMap(map);

								}

								

								// var districtShapeCoords = jQuery.get('https://box-shp.alias.s24cloud.net/shape/'+disctrictShapeId[2].id)

								// console.log('district coords ' + districtShapeCoords)

							{% endif %}
						}
					} else {
						jQuery('.ff-consent').fadeIn();
						jQuery('.ff-consent-box').css('background-color', '#fafafa');
						jQuery( "#ffmap-details" ).css('display', 'none');
						ffconsent = true
					}
				});

				// create locations
				var locations = [
					{% for id,estates in page.results %}
						{% if estates.geo %}
							{% if estates.geo.latitude.value %}
								{lat: {{ estates.geo.latitude.value-0.0000322 }}, lng:{{estates.geo.longitude.value-0.0000322}}},
							{% endif %}
						{% endif %}
					{% endfor %}
				]

				var getGoogleClusterMarkerSvg = function (color) {
					var encoded = window.btoa('<?xml version="1.0"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" viewBox="0 0 487.724 487.724" style="enable-background:new 0 0 487.724 487.724;" xml:space="preserve" width="30px" height="30px" class=""><g><g><g><path d="M236.925,0.124c-96.9,3.4-177.4,79-186.7,175.5c-1.9,19.3-0.8,38,2.6,55.9l0,0c0,0,0.3,2.1,1.3,6.1    c3,13.4,7.5,26.4,13.1,38.6c19.5,46.2,64.6,123.5,165.8,207.6c6.2,5.2,15.3,5.2,21.6,0c101.2-84,146.3-161.3,165.9-207.7    c5.7-12.2,10.1-25.1,13.1-38.6c0.9-3.9,1.3-6.1,1.3-6.1l0,0c2.3-12,3.5-24.3,3.5-36.9C438.425,84.724,347.525-3.776,236.925,0.124    z M243.825,291.324c-52.2,0-94.5-42.3-94.5-94.5s42.3-94.5,94.5-94.5s94.5,42.3,94.5,94.5S296.025,291.324,243.825,291.324z" data-original="#000000" class="active-path" data-old_color="#Ff0000" stroke-width="10" stroke="#ccc" stroke-opacity="0.8" fill="' + color + '"/>	</g></g></g> </svg>');

					return ('data:image/svg+xml;base64,' + encoded);
				};



			</script>
		{% endif %}
	{% elseif ff_maps_default_provider == 2 %}
		<div class="FFestateview-default-map">
			<div class="ffmap-consent-osm">

				{% if estates.facts.addresses.value.street %}
					<div id="osm-single-property" data-lng="{{ estates.geo.longitude.value }}" data-lat="{{ estates.geo.latitude.value }}"></div>
				{% else %}
					<div id="osm-single-property" data-zip="{{ estates.contact.addresses.values.0.zipcode }}" data-town="{{ estates.facts.addresses.value.city }}"></div>
					<div id="estate-coords" data-lng="{{ estates.geo.longitude.value }}" data-lat="{{ estates.geo.latitude.value }}"></div>
				{% endif %}

				
				
				<div class="ff-consent-box">
					<div class="ff-consent">
						<b><small>Ergebnisse auf Karte anzeigen </small></b><br>
						<small>Diese Webseite nutzt OSM. Ich bin damit einverstanden,
						dass OSM für die Darstellung von Karten und für die
						eigene Zwecke die IP-Adresse meines Gerätes sowie weitere
						technische Daten erhält. Mit Aktivierung werden diese Daten an
						Google übermittelt. {% if privacy_page_url %} Weitere Details im <a href="{{ privacy_page_url }}" target="_blank">Datenschutzhinweis</a>.{% endif %} </small><br> 
						
					</div>
					<div class="ff-gmaps-consent">
						<div><small><b>OSM nutzen</b></small></div>
						
						<label class="ff-button-switch">
							<input type="checkbox" id="map-switch">
							<span class="ff-button-slider round"></span>
						</label>
					</div>
				</div>
			</div>
		</div>
	{% endif %}
{% endif %}
